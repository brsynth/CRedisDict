version: '3.8'

x-common:
   &default
    image: ${PACKAGE}-tests_conda
    build:
      context: ../../..
      args:
        HOME: ${HOMEDIR}
        IMAGE: ${BASE_IMAGE}
      dockerfile: tests/conda/docker/Dockerfile
    volumes:
      - $PWD/..:${HOMEDIR}:ro
      - conda_build:${CONDA_BLD_PATH}

services:

  build:
    <<: *default
    command: "rm -rf ${CONDA_BLD_PATH}/*
           && conda build --no-test \
                -c brsynth \
                -c conda-forge \
                --output-folder ${CONDA_BLD_PATH} recipe"

  test:
    <<: *default
    command: "conda build --test \
                -c brsynth \
                -c conda-forge \
                ${CONDA_BLD_PATH}/*/${PACKAGE}-*.tar.bz2"

  convert:
    <<: *default
    command: "conda convert \
                --platform osx-64 \
                --platform linux-64 \
                --platform win-64 \
                --output-dir ${CONDA_BLD_PATH} \
                ${CONDA_BLD_PATH}/*/${PACKAGE}-*"

  publish:
    <<: *default
    command: "anaconda \
                upload \
                --user brsynth \
                --label main \
                ${CONDA_BLD_PATH}/*/${PACKAGE}-*.tar.bz2"

volumes:
  input_cache:
  cache:
  conda_build:
    name: ${PACKAGE}_conda_build
